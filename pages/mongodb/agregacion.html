<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <title>Pipeline de Agregaci√≥n - Wiki 2¬∫ DAW</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo"><i class="fas fa-book-open"></i><h1>Wiki 2¬∫ DAW</h1></div>
            <a href="./index.html" class="back-button"><i class="fas fa-arrow-left"></i> Volver a MongoDB</a>
        </div>
    </nav>
    <div class="content-with-sidebar">
        <aside class="sidebar">
            <h3 class="sidebar-title"><i class="fas fa-database"></i> Agregaci√≥n</h3>
            <ul class="sidebar-nav">
                <li><a href="#intro" class="active">Introducci√≥n al Pipeline</a></li>
                <li><a href="#match">$match - Filtrar</a></li>
                <li><a href="#group">$group - Agrupar</a></li>
                <li><a href="#project">$project - Transformar</a></li>
                <li><a href="#sort-limit">$sort, $limit, $skip</a></li>
                <li><a href="#unwind">$unwind - Descomponer Arrays</a></li>
                <li><a href="#lookup">$lookup - Joins</a></li>
                <li><a href="#ejemplos">Ejemplos Complejos</a></li>
            </ul>
        </aside>
        <main class="main-content">
            <div class="detail-header">
                <div class="detail-icon" style="color: var(--mongodb-color);"><i class="fas fa-database"></i></div>
                <h1 class="detail-title">4. Pipeline de Agregaci√≥n en MongoDB</h1>
                <p class="detail-subtitle">An√°lisis y transformaci√≥n avanzada de datos</p>
            </div>

            <div class="content-section" id="intro">
                <h2><i class="fas fa-stream"></i> ¬øQu√© es el Aggregation Pipeline?</h2>
                <p>El <strong>Aggregation Pipeline</strong> es el framework de MongoDB para procesar y transformar documentos. Es similar a una tuber√≠a donde los documentos pasan a trav√©s de m√∫ltiples <strong>etapas</strong> (stages), y cada etapa transforma los datos de alguna manera.</p>

                <p><strong>¬øPor qu√© es importante?</strong></p>
                <ul>
                    <li><strong>An√°lisis de datos:</strong> Calcula estad√≠sticas, promedios, totales, agrupaciones</li>
                    <li><strong>Transformaci√≥n:</strong> Modifica la estructura de documentos, crea campos calculados</li>
                    <li><strong>Rendimiento:</strong> Procesa datos en el servidor (m√°s r√°pido que en la aplicaci√≥n)</li>
                    <li><strong>Flexibilidad:</strong> Combina m√∫ltiples operaciones en una sola consulta</li>
                    <li><strong>Potencia:</strong> Equivalente a consultas SQL complejas con GROUP BY, JOIN, etc.</li>
                </ul>

                <div class="info-box">
                    <strong>üí° Comparaci√≥n con SQL:</strong>
                    <div class="code-block"><pre>// SQL:
SELECT categoria, 
       COUNT(*) as total,
       AVG(precio) as precioPromedio
FROM productos
WHERE stock > 0
GROUP BY categoria
HAVING COUNT(*) > 5
ORDER BY total DESC
LIMIT 10

// MongoDB Aggregation Pipeline (equivalente):
db.productos.aggregate([
  { $match: { stock: { $gt: 0 } } },
  { 
    $group: {
      _id: "$categoria",
      total: { $sum: 1 },
      precioPromedio: { $avg: "$precio" }
    }
  },
  { $match: { total: { $gt: 5 } } },
  { $sort: { total: -1 } },
  { $limit: 10 }
])</pre></div>
                </div>

                <h3>Estructura del Pipeline</h3>
                <p>Un pipeline es un array de etapas. Cada etapa es un objeto que especifica una operaci√≥n:</p>

                <div class="code-block"><pre>db.coleccion.aggregate([
  { $etapa1: { ... } },  // Primera transformaci√≥n
  { $etapa2: { ... } },  // Segunda transformaci√≥n
  { $etapa3: { ... } }   // Tercera transformaci√≥n
])

// Los documentos fluyen de arriba hacia abajo:
// Documentos originales ‚Üí Etapa1 ‚Üí Resultado1 ‚Üí Etapa2 ‚Üí Resultado2 ‚Üí ...

// Ejemplo visual:
// Entrada: 1000 documentos
//    ‚Üì
// $match (filtrar) ‚Üí 500 documentos
//    ‚Üì
// $group (agrupar) ‚Üí 10 grupos
//    ‚Üì
// $sort (ordenar) ‚Üí 10 grupos ordenados
//    ‚Üì
// Salida: 10 documentos finales</pre></div>

                <h3>Etapas Principales</h3>
                <p>MongoDB ofrece m√°s de 30 etapas. Las m√°s comunes son:</p>
                <ul>
                    <li><code>$match</code> - Filtra documentos (como find())</li>
                    <li><code>$group</code> - Agrupa documentos y calcula valores</li>
                    <li><code>$project</code> - Selecciona/transforma campos</li>
                    <li><code>$sort</code> - Ordena documentos</li>
                    <li><code>$limit</code> - Limita n√∫mero de documentos</li>
                    <li><code>$skip</code> - Salta documentos</li>
                    <li><code>$unwind</code> - Descompone arrays</li>
                    <li><code>$lookup</code> - Join con otra colecci√≥n</li>
                    <li><code>$addFields</code> - A√±ade campos calculados</li>
                    <li><code>$count</code> - Cuenta documentos</li>
                </ul>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Orden de las etapas importa:</strong>
                    <p>El orden afecta tanto la l√≥gica como el rendimiento:</p>
                    <ul>
                        <li><strong>Coloca $match temprano:</strong> Filtra antes de procesar para reducir datos</li>
                        <li><strong>$project despu√©s de $group:</strong> Solo proyecta lo necesario al final</li>
                        <li><strong>√çndices:</strong> Solo la primera $match puede usar √≠ndices eficientemente</li>
                    </ul>
                </div>
            </div>

            <div class="content-section" id="match">
                <h2><i class="fas fa-filter"></i> $match - Filtrar Documentos</h2>
                <p><code>$match</code> filtra documentos que pasan a la siguiente etapa. Es equivalente a <code>find()</code> pero se usa dentro del pipeline.</p>

                <h3>Sintaxis B√°sica</h3>
                <div class="code-block"><pre>// Sintaxis:
{ $match: { campo: valor } }

// Ejemplo simple:
db.ventas.aggregate([
  { $match: { estado: "completado" } }
])
// Solo documentos con estado "completado"</pre></div>

                <h3>Con Operadores de Consulta</h3>
                <p><code>$match</code> soporta todos los operadores de consulta de MongoDB:</p>

                <div class="code-block"><pre>// Rango de fechas:
db.ventas.aggregate([
  {
    $match: {
      fecha: {
        $gte: ISODate("2024-01-01"),
        $lt: ISODate("2024-02-01")
      }
    }
  }
])

// M√∫ltiples condiciones:
db.productos.aggregate([
  {
    $match: {
      categoria: "Electr√≥nica",
      precio: { $gte: 100, $lte: 500 },
      stock: { $gt: 0 }
    }
  }
])

// Con operadores l√≥gicos:
db.usuarios.aggregate([
  {
    $match: {
      $or: [
        { edad: { $gte: 65 } },
        { tipoCliente: "premium" }
      ]
    }
  }
])</pre></div>

                <h3>M√∫ltiples $match en un Pipeline</h3>
                <p>Puedes usar $match varias veces para filtrar en diferentes etapas:</p>

                <div class="code-block"><pre>db.ventas.aggregate([
  // Primer filtro: solo ventas completadas
  { $match: { estado: "completado" } },
  
  // Agrupar por producto
  {
    $group: {
      _id: "$producto",
      totalVentas: { $sum: "$cantidad" }
    }
  },
  
  // Segundo filtro: solo productos con m√°s de 100 ventas
  { $match: { totalVentas: { $gt: 100 } } }
])</pre></div>

                <div class="info-box">
                    <strong>üí° Optimizaci√≥n con $match:</strong>
                    <ul>
                        <li><strong>Primera etapa:</strong> Si $match es la primera etapa, puede usar √≠ndices</li>
                        <li><strong>Reduce datos temprano:</strong> Menos documentos = procesamiento m√°s r√°pido</li>
                        <li><strong>Divide filtros:</strong> Filtra datos originales primero, luego resultados agregados</li>
                    </ul>
                </div>
            </div>

            <div class="content-section" id="group">
                <h2><i class="fas fa-object-group"></i> $group - Agrupar y Calcular</h2>
                <p><code>$group</code> agrupa documentos por un campo espec√≠fico y calcula valores agregados. Es equivalente a SQL's GROUP BY.</p>

                <h3>Sintaxis B√°sica</h3>
                <div class="code-block"><pre>// Sintaxis:
{
  $group: {
    _id: "$campoParaAgrupar",  // Campo de agrupaci√≥n (obligatorio)
    campo1: { $operador: "$campo" },
    campo2: { $operador: "$campo" }
  }
}</pre></div>

                <h3>Agrupar por un Campo</h3>
                <div class="code-block"><pre>// Contar usuarios por ciudad:
db.usuarios.aggregate([
  {
    $group: {
      _id: "$ciudad",           // Agrupar por ciudad
      total: { $sum: 1 }        // Contar documentos
    }
  }
])

// Resultado:
[
  { _id: "Madrid", total: 150 },
  { _id: "Barcelona", total: 120 },
  { _id: "Valencia", total: 80 }
]</pre></div>

                <h3>Operadores de Acumulaci√≥n</h3>

                <h4>$sum - Sumar</h4>
                <div class="code-block"><pre>// Contar documentos (suma 1 por cada documento):
{ $sum: 1 }

// Sumar valores de un campo:
db.ventas.aggregate([
  {
    $group: {
      _id: "$categoria",
      totalVentas: { $sum: "$precio" }
    }
  }
])

// Sumar campo calculado:
db.pedidos.aggregate([
  {
    $group: {
      _id: "$usuarioId",
      gastTotal: { $sum: { $multiply: ["$precio", "$cantidad"] } }
    }
  }
])</pre></div>

                <h4>$avg - Promedio</h4>
                <div class="code-block"><pre>// Edad promedio por ciudad:
db.usuarios.aggregate([
  {
    $group: {
      _id: "$ciudad",
      edadPromedio: { $avg: "$edad" }
    }
  }
])

// Precio promedio por categor√≠a:
db.productos.aggregate([
  {
    $group: {
      _id: "$categoria",
      precioPromedio: { $avg: "$precio" }
    }
  }
])</pre></div>

                <h4>$min y $max - M√≠nimo y M√°ximo</h4>
                <div class="code-block"><pre>// Producto m√°s barato y m√°s caro por categor√≠a:
db.productos.aggregate([
  {
    $group: {
      _id: "$categoria",
      precioMin: { $min: "$precio" },
      precioMax: { $max: "$precio" }
    }
  }
])

// Primera y √∫ltima venta de cada producto:
db.ventas.aggregate([
  {
    $group: {
      _id: "$producto",
      primeraVenta: { $min: "$fecha" },
      ultimaVenta: { $max: "$fecha" }
    }
  }
])</pre></div>

                <h4>$first y $last - Primer y √öltimo Documento</h4>
                <div class="code-block"><pre>// IMPORTANTE: Requiere $sort antes para ser √∫til
db.ventas.aggregate([
  { $sort: { fecha: 1 } },  // Ordenar por fecha ascendente
  {
    $group: {
      _id: "$usuarioId",
      primeraCompra: { $first: "$fecha" },
      ultimaCompra: { $last: "$fecha" }
    }
  }
])</pre></div>

                <h4>$push y $addToSet - Acumular en Arrays</h4>
                <div class="code-block"><pre>// $push: A√±ade todos los valores (con duplicados)
db.pedidos.aggregate([
  {
    $group: {
      _id: "$usuarioId",
      productos: { $push: "$nombreProducto" }
    }
  }
])
// Resultado: { _id: 1, productos: ["Libro", "Rat√≥n", "Libro"] }

// $addToSet: A√±ade valores √∫nicos (sin duplicados)
db.pedidos.aggregate([
  {
    $group: {
      _id: "$usuarioId",
      productosUnicos: { $addToSet: "$nombreProducto" }
    }
  }
])
// Resultado: { _id: 1, productosUnicos: ["Libro", "Rat√≥n"] }</pre></div>

                <h3>Agrupar por M√∫ltiples Campos</h3>
                <div class="code-block"><pre>// Ventas por ciudad Y categor√≠a:
db.ventas.aggregate([
  {
    $group: {
      _id: {
        ciudad: "$ciudad",
        categoria: "$categoria"
      },
      total: { $sum: "$precio" }
    }
  }
])

// Resultado:
[
  { _id: { ciudad: "Madrid", categoria: "Libros" }, total: 5000 },
  { _id: { ciudad: "Madrid", categoria: "M√∫sica" }, total: 3000 },
  { _id: { ciudad: "Barcelona", categoria: "Libros" }, total: 4500 }
]</pre></div>

                <h3>Agrupar Todos los Documentos</h3>
                <div class="code-block"><pre>// Usar _id: null para agrupar todos:
db.ventas.aggregate([
  {
    $group: {
      _id: null,                    // Agrupa todo
      totalVentas: { $sum: "$precio" },
      ventaPromedio: { $avg: "$precio" },
      numVentas: { $sum: 1 }
    }
  }
])

// Resultado:
[
  {
    _id: null,
    totalVentas: 50000,
    ventaPromedio: 125.50,
    numVentas: 398
  }
]</pre></div>

                <div class="info-box">
                    <strong>üí° Ejemplo Completo - Estad√≠sticas de Ventas:</strong>
                    <div class="code-block"><pre>db.ventas.aggregate([
  // 1. Filtrar solo 2024
  { 
    $match: { 
      fecha: { 
        $gte: ISODate("2024-01-01"),
        $lt: ISODate("2025-01-01")
      } 
    } 
  },
  // 2. Agrupar por producto
  {
    $group: {
      _id: "$producto",
      cantidadVendida: { $sum: "$cantidad" },
      ingresos: { $sum: { $multiply: ["$precio", "$cantidad"] } },
      precioPromedio: { $avg: "$precio" },
      numVentas: { $sum: 1 }
    }
  },
  // 3. Filtrar productos rentables
  { $match: { ingresos: { $gte: 1000 } } },
  // 4. Ordenar por ingresos
  { $sort: { ingresos: -1 } }
])</pre></div>
                </div>
            </div>

            <div class="content-section" id="project">
                <h2><i class="fas fa-pencil-ruler"></i> $project - Transformar y Dar Forma a Documentos</h2>
                <p><code>$project</code> controla qu√© campos aparecen en la salida y puede crear campos calculados. Similar a SELECT en SQL.</p>

                <h3>Incluir/Excluir Campos</h3>
                <div class="code-block"><pre>// Incluir solo campos espec√≠ficos:
db.usuarios.aggregate([
  {
    $project: {
      nombre: 1,
      email: 1,
      ciudad: 1
      // _id se incluye por defecto
    }
  }
])

// Excluir _id:
db.usuarios.aggregate([
  {
    $project: {
      _id: 0,
      nombre: 1,
      email: 1
    }
  }
])

// Excluir campos espec√≠ficos:
db.usuarios.aggregate([
  {
    $project: {
      password: 0,
      tokenSession: 0
    }
  }
])</pre></div>

                <h3>Renombrar Campos</h3>
                <div class="code-block"><pre>db.usuarios.aggregate([
  {
    $project: {
      _id: 0,
      nombreUsuario: "$nombre",     // Renombrar "nombre" a "nombreUsuario"
      correo: "$email",             // Renombrar "email" a "correo"
      ubicacion: "$ciudad"
    }
  }
])</pre></div>

                <h3>Crear Campos Calculados</h3>

                <h4>Operadores Aritm√©ticos</h4>
                <div class="code-block"><pre>// $add, $subtract, $multiply, $divide
db.productos.aggregate([
  {
    $project: {
      nombre: 1,
      precio: 1,
      precioConIVA: { $multiply: ["$precio", 1.21] },
      descuento: { $multiply: ["$precio", 0.10] },
      precioFinal: {
        $subtract: [
          { $multiply: ["$precio", 1.21] },
          { $multiply: ["$precio", 0.10] }
        ]
      }
    }
  }
])</pre></div>

                <h4>Operadores de String</h4>
                <div class="code-block"><pre>// $concat - Concatenar strings:
db.usuarios.aggregate([
  {
    $project: {
      nombreCompleto: {
        $concat: ["$nombre", " ", "$apellido"]
      },
      emailFormateado: {
        $concat: ["Email: ", "$email"]
      }
    }
  }
])

// $toUpper, $toLower - May√∫sculas/min√∫sculas:
db.usuarios.aggregate([
  {
    $project: {
      nombreMayusculas: { $toUpper: "$nombre" },
      emailMinusculas: { $toLower: "$email" }
    }
  }
])

// $substr - Subcadena:
db.usuarios.aggregate([
  {
    $project: {
      iniciales: { $substr: ["$nombre", 0, 1] }
    }
  }
])</pre></div>

                <h4>Operadores Condicionales</h4>
                <div class="code-block"><pre>// $cond - If-then-else:
db.productos.aggregate([
  {
    $project: {
      nombre: 1,
      precio: 1,
      categoria: {
        $cond: {
          if: { $gte: ["$precio", 100] },
          then: "Premium",
          else: "Econ√≥mico"
        }
      }
    }
  }
])

// Forma abreviada:
db.productos.aggregate([
  {
    $project: {
      categoria: {
        $cond: [
          { $gte: ["$precio", 100] },
          "Premium",
          "Econ√≥mico"
        ]
      }
    }
  }
])

// $switch - M√∫ltiples condiciones:
db.usuarios.aggregate([
  {
    $project: {
      rangoEdad: {
        $switch: {
          branches: [
            { case: { $lt: ["$edad", 18] }, then: "Menor" },
            { case: { $lt: ["$edad", 65] }, then: "Adulto" },
            { case: { $gte: ["$edad", 65] }, then: "Senior" }
          ],
          default: "Desconocido"
        }
      }
    }
  }
])</pre></div>

                <h4>Operadores de Fecha</h4>
                <div class="code-block"><pre>// Extraer componentes de fecha:
db.ventas.aggregate([
  {
    $project: {
      a√±o: { $year: "$fecha" },
      mes: { $month: "$fecha" },
      dia: { $dayOfMonth: "$fecha" },
      diaSemana: { $dayOfWeek: "$fecha" },  // 1 = Domingo
      hora: { $hour: "$fecha" }
    }
  }
])</pre></div>

                <h3>$addFields - A√±adir Campos sin Excluir Otros</h3>
                <p><code>$addFields</code> es como $project pero mantiene todos los campos originales:</p>

                <div class="code-block"><pre>// $project: Solo campos especificados
db.productos.aggregate([
  {
    $project: {
      nombre: 1,
      precioConIVA: { $multiply: ["$precio", 1.21] }
      // ‚ùå Todos los dem√°s campos se excluyen
    }
  }
])

// $addFields: A√±ade campo, mantiene todo lo dem√°s
db.productos.aggregate([
  {
    $addFields: {
      precioConIVA: { $multiply: ["$precio", 1.21] }
      // ‚úÖ Todos los campos originales + el nuevo
    }
  }
])</pre></div>
            </div>

            <div class="content-section" id="sort-limit">
                <h2><i class="fas fa-sort"></i> $sort, $limit y $skip</h2>
                <p>Estas etapas controlan el orden y la cantidad de documentos en el pipeline.</p>

                <h3>$sort - Ordenar</h3>
                <div class="code-block"><pre>// Sintaxis: 1 = ascendente, -1 = descendente
db.productos.aggregate([
  { $sort: { precio: -1 } }  // M√°s caros primero
])

// Ordenar por m√∫ltiples campos:
db.ventas.aggregate([
  { $sort: { categoria: 1, precio: -1 } }
  // Primero por categor√≠a (A-Z), luego por precio (mayor a menor)
])</pre></div>

                <h3>$limit - Limitar</h3>
                <div class="code-block"><pre>// Top 10 productos m√°s vendidos:
db.ventas.aggregate([
  {
    $group: {
      _id: "$producto",
      totalVentas: { $sum: "$cantidad" }
    }
  },
  { $sort: { totalVentas: -1 } },
  { $limit: 10 }
])</pre></div>

                <h3>$skip - Saltar</h3>
                <div class="code-block"><pre>// Paginaci√≥n:
const pagina = 2;
const porPagina = 20;

db.productos.aggregate([
  { $sort: { nombre: 1 } },
  { $skip: (pagina - 1) * porPagina },
  { $limit: porPagina }
])</pre></div>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Orden de $sort, $limit, $skip:</strong>
                    <p>MongoDB optimiza autom√°ticamente estas etapas, pero el orden l√≥gico es:</p>
                    <ol>
                        <li>$sort - Ordena todos los documentos</li>
                        <li>$skip - Salta N documentos</li>
                        <li>$limit - Devuelve M documentos</li>
                    </ol>
                </div>
            </div>

            <div class="content-section" id="unwind">
                <h2><i class="fas fa-expand-arrows-alt"></i> $unwind - Descomponer Arrays</h2>
                <p><code>$unwind</code> "descompone" un array, creando un documento por cada elemento del array.</p>

                <h3>Concepto de $unwind</h3>
                <div class="code-block"><pre>// Documento original:
{
  _id: 1,
  usuario: "Ana",
  hobbies: ["lectura", "m√∫sica", "nataci√≥n"]
}

// Despu√©s de $unwind sobre "hobbies":
[
  { _id: 1, usuario: "Ana", hobbies: "lectura" },
  { _id: 1, usuario: "Ana", hobbies: "m√∫sica" },
  { _id: 1, usuario: "Ana", hobbies: "nataci√≥n" }
]
// ‚úÖ Un documento por cada elemento del array</pre></div>

                <h3>Sintaxis B√°sica</h3>
                <div class="code-block"><pre>// Sintaxis simple:
{ $unwind: "$nombreArray" }

// Ejemplo:
db.usuarios.aggregate([
  { $unwind: "$hobbies" }
])</pre></div>

                <h3>Caso de Uso Real - An√°lisis de Productos en Pedidos</h3>
                <div class="code-block"><pre>// Colecci√≥n pedidos:
{
  _id: 1,
  usuario: "Ana",
  productos: [
    { nombre: "Libro", precio: 20, cantidad: 2 },
    { nombre: "Rat√≥n", precio: 15, cantidad: 1 }
  ]
}

// Contar ventas por producto:
db.pedidos.aggregate([
  // 1. Descomponer array de productos
  { $unwind: "$productos" },
  
  // 2. Agrupar por nombre de producto
  {
    $group: {
      _id: "$productos.nombre",
      totalVendido: { $sum: "$productos.cantidad" },
      ingresos: { 
        $sum: { 
          $multiply: ["$productos.precio", "$productos.cantidad"] 
        } 
      }
    }
  },
  
  // 3. Ordenar por m√°s vendidos
  { $sort: { totalVendido: -1 } }
])

// Resultado:
[
  { _id: "Libro", totalVendido: 150, ingresos: 3000 },
  { _id: "Rat√≥n", totalVendido: 80, ingresos: 1200 }
]</pre></div>

                <h3>Opciones de $unwind</h3>
                <div class="code-block"><pre>// Sintaxis completa:
{
  $unwind: {
    path: "$array",
    preserveNullAndEmptyArrays: true,  // Mantener docs sin array/array vac√≠o
    includeArrayIndex: "indice"        // A√±adir √≠ndice del elemento
  }
}

// Ejemplo:
db.usuarios.aggregate([
  {
    $unwind: {
      path: "$hobbies",
      includeArrayIndex: "posicionHobby",
      preserveNullAndEmptyArrays: true
    }
  }
])

// Resultado incluye documentos sin hobbies:
{ _id: 1, usuario: "Ana", hobbies: "lectura", posicionHobby: 0 }
{ _id: 1, usuario: "Ana", hobbies: "m√∫sica", posicionHobby: 1 }
{ _id: 2, usuario: "Luis" }  // ‚úÖ Sin hobbies pero incluido</pre></div>
            </div>

            <div class="content-section" id="lookup">
                <h2><i class="fas fa-link"></i> $lookup - Joins entre Colecciones</h2>
                <p><code>$lookup</code> realiza un LEFT OUTER JOIN entre dos colecciones, similar a JOIN en SQL.</p>

                <h3>Sintaxis B√°sica</h3>
                <div class="code-block"><pre>// Sintaxis:
{
  $lookup: {
    from: "coleccionExterna",        // Colecci√≥n a unir
    localField: "campoLocal",         // Campo de la colecci√≥n actual
    foreignField: "campoExterno",     // Campo de la colecci√≥n externa
    as: "nombreResultado"             // Nombre del array resultante
  }
}</pre></div>

                <h3>Ejemplo - Pedidos con Datos de Usuario</h3>
                <div class="code-block"><pre>// Colecci√≥n "pedidos":
{
  _id: 1,
  usuarioId: ObjectId("abc123"),
  total: 150,
  fecha: ISODate("2024-01-15")
}

// Colecci√≥n "usuarios":
{
  _id: ObjectId("abc123"),
  nombre: "Ana Garc√≠a",
  email: "ana@example.com"
}

// JOIN:
db.pedidos.aggregate([
  {
    $lookup: {
      from: "usuarios",
      localField: "usuarioId",
      foreignField: "_id",
      as: "datosUsuario"
    }
  }
])

// Resultado:
{
  _id: 1,
  usuarioId: ObjectId("abc123"),
  total: 150,
  fecha: ISODate("2024-01-15"),
  datosUsuario: [  // ‚Üê Array con el usuario
    {
      _id: ObjectId("abc123"),
      nombre: "Ana Garc√≠a",
      email: "ana@example.com"
    }
  ]
}</pre></div>

                <h3>Convertir Array a Objeto con $unwind</h3>
                <p>$lookup devuelve un array. Usa $unwind para convertirlo en objeto:</p>

                <div class="code-block"><pre>db.pedidos.aggregate([
  {
    $lookup: {
      from: "usuarios",
      localField: "usuarioId",
      foreignField: "_id",
      as: "datosUsuario"
    }
  },
  { $unwind: "$datosUsuario" },  // Array ‚Üí Objeto
  {
    $project: {
      _id: 1,
      total: 1,
      nombreUsuario: "$datosUsuario.nombre",
      emailUsuario: "$datosUsuario.email"
    }
  }
])

// Resultado:
{
  _id: 1,
  total: 150,
  nombreUsuario: "Ana Garc√≠a",
  emailUsuario: "ana@example.com"
}</pre></div>

                <h3>$lookup con Pipeline (Avanzado)</h3>
                <p>Puedes ejecutar un pipeline en la colecci√≥n externa:</p>

                <div class="code-block"><pre>db.pedidos.aggregate([
  {
    $lookup: {
      from: "productos",
      let: { productoIds: "$productos" },  // Variables
      pipeline: [
        {
          $match: {
            $expr: { $in: ["$_id", "$$productoIds"] }  // $$var
          }
        },
        { $project: { nombre: 1, precio: 1 } }
      ],
      as: "detallesProductos"
    }
  }
])</pre></div>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Rendimiento de $lookup:</strong>
                    <ul>
                        <li>$lookup puede ser costoso en colecciones grandes</li>
                        <li>Crea √≠ndices en los campos de join (localField y foreignField)</li>
                        <li>Considera desnormalizar datos si haces joins frecuentemente</li>
                        <li>Usa $match despu√©s de $lookup para filtrar resultados unidos</li>
                    </ul>
                </div>
            </div>

            <div class="content-section" id="ejemplos">
                <h2><i class="fas fa-code"></i> Ejemplos de Pipelines Complejos</h2>
                <p>Ejemplos reales que combinan m√∫ltiples etapas:</p>

                <h3>Ejemplo 1: Dashboard de Ventas</h3>
                <div class="code-block"><pre>// An√°lisis de ventas por categor√≠a y mes
db.ventas.aggregate([
  // 1. Filtrar ventas de 2024
  {
    $match: {
      fecha: {
        $gte: ISODate("2024-01-01"),
        $lt: ISODate("2025-01-01")
      },
      estado: "completado"
    }
  },
  
  // 2. Extraer a√±o y mes
  {
    $addFields: {
      a√±o: { $year: "$fecha" },
      mes: { $month: "$fecha" }
    }
  },
  
  // 3. Agrupar por categor√≠a y mes
  {
    $group: {
      _id: {
        categoria: "$categoria",
        mes: "$mes"
      },
      totalVentas: { $sum: "$cantidad" },
      ingresos: { $sum: { $multiply: ["$precio", "$cantidad"] } },
      ventaPromedio: { $avg: { $multiply: ["$precio", "$cantidad"] } },
      numTransacciones: { $sum: 1 }
    }
  },
  
  // 4. Ordenar por mes y ingresos
  { $sort: { "_id.mes": 1, ingresos: -1 } },
  
  // 5. Formatear salida
  {
    $project: {
      _id: 0,
      categoria: "$_id.categoria",
      mes: "$_id.mes",
      totalVentas: 1,
      ingresos: { $round: ["$ingresos", 2] },
      ventaPromedio: { $round: ["$ventaPromedio", 2] },
      numTransacciones: 1
    }
  }
])</pre></div>

                <h3>Ejemplo 2: Top Clientes con Detalles</h3>
                <div class="code-block"><pre>// Top 10 clientes que m√°s gastaron
db.pedidos.aggregate([
  // 1. Solo pedidos completados
  { $match: { estado: "completado" } },
  
  // 2. Agrupar por cliente
  {
    $group: {
      _id: "$usuarioId",
      totalGastado: { $sum: "$total" },
      numPedidos: { $sum: 1 },
      ultimoPedido: { $max: "$fecha" }
    }
  },
  
  // 3. Ordenar por gasto total
  { $sort: { totalGastado: -1 } },
  
  // 4. Top 10
  { $limit: 10 },
  
  // 5. JOIN con usuarios
  {
    $lookup: {
      from: "usuarios",
      localField: "_id",
      foreignField: "_id",
      as: "datosUsuario"
    }
  },
  
  // 6. Descomponer array de usuario
  { $unwind: "$datosUsuario" },
  
  // 7. Formatear salida
  {
    $project: {
      _id: 0,
      usuarioId: "$_id",
      nombre: "$datosUsuario.nombre",
      email: "$datosUsuario.email",
      totalGastado: { $round: ["$totalGastado", 2] },
      numPedidos: 1,
      promedioGasto: { 
        $round: [{ $divide: ["$totalGastado", "$numPedidos"] }, 2] 
      },
      ultimoPedido: {
        $dateToString: {
          format: "%Y-%m-%d",
          date: "$ultimoPedido"
        }
      }
    }
  }
])</pre></div>

                <h3>Ejemplo 3: An√°lisis de Productos en Pedidos</h3>
                <div class="code-block"><pre>// Productos m√°s vendidos con an√°lisis detallado
db.pedidos.aggregate([
  // 1. Descomponer array de productos
  { $unwind: "$productos" },
  
  // 2. Agrupar por producto
  {
    $group: {
      _id: "$productos.nombre",
      cantidadTotal: { $sum: "$productos.cantidad" },
      ingresos: { 
        $sum: { 
          $multiply: ["$productos.precio", "$productos.cantidad"] 
        } 
      },
      precioPromedio: { $avg: "$productos.precio" },
      numPedidos: { $sum: 1 },
      clientes: { $addToSet: "$usuarioId" }
    }
  },
  
  // 3. A√±adir campo calculado
  {
    $addFields: {
      numClientesUnicos: { $size: "$clientes" },
      ingresoPorPedido: { $divide: ["$ingresos", "$numPedidos"] }
    }
  },
  
  // 4. Filtrar productos populares
  { $match: { numPedidos: { $gte: 10 } } },
  
  // 5. Ordenar por ingresos
  { $sort: { ingresos: -1 } },
  
  // 6. Formatear salida
  {
    $project: {
      _id: 0,
      producto: "$_id",
      cantidadTotal: 1,
      ingresos: { $round: ["$ingresos", 2] },
      precioPromedio: { $round: ["$precioPromedio", 2] },
      numPedidos: 1,
      numClientesUnicos: 1,
      ingresoPorPedido: { $round: ["$ingresoPorPedido", 2] }
    }
  }
])</pre></div>

                <div class="info-box">
                    <strong>üí° Resumen del Aggregation Pipeline:</strong>
                    <ul>
                        <li><strong>$match:</strong> Filtra documentos (usa √≠ndices si es primera etapa)</li>
                        <li><strong>$group:</strong> Agrupa y calcula ($sum, $avg, $min, $max, etc.)</li>
                        <li><strong>$project:</strong> Transforma documentos, crea campos calculados</li>
                        <li><strong>$sort / $limit / $skip:</strong> Ordena, limita y pagina resultados</li>
                        <li><strong>$unwind:</strong> Descompone arrays (un doc por elemento)</li>
                        <li><strong>$lookup:</strong> JOIN con otra colecci√≥n</li>
                        <li><strong>$addFields:</strong> A√±ade campos sin excluir existentes</li>
                        <li><strong>Orden importa:</strong> Filtra temprano, proyecta al final</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>
    <script src="../../js/main.js"></script>
    <script>document.addEventListener('DOMContentLoaded',function(){const sections=document.querySelectorAll('.content-section');const navLinks=document.querySelectorAll('.sidebar-nav a');function changeActiveLink(){let currentSection='';sections.forEach(section=>{const sectionTop=section.offsetTop;if(window.pageYOffset>=sectionTop-100){currentSection=section.getAttribute('id');}});navLinks.forEach(link=>{link.classList.remove('active');if(link.getAttribute('href')==='#'+currentSection){link.classList.add('active');}});}window.addEventListener('scroll',changeActiveLink);});</script>
</body>
</html>